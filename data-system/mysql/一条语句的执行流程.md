# 一条语句的执行流程

## 查询语句

1. **建立连接：** 通过连接器建立与服务端的连接
2. **查询缓存：** 一般不怎么使用（查询语句要完全一致、数据表更新后缓存失效导致维护成本过高）
3. **分析器：** 对 SQL 语句做词法分析
4. **优化器：**
   生成执行计划，主要的工作是数据表包含索引的时候，判定是否使用索引，以及使用哪些索引效率最高（扫描行数最少）（可以通过  `explain`
   语句查看它的执行计划）
5. **执行器：** 在根据执行计划执行 SQL 查询语句时，会先**验证权限**，有相应的权限才会继续执行，否则会报权限错误

## 更新语句

- **执行流程**

    1. **建立连接**
    2. **分析器**
    3. **优化器**
    4. **执行器**
        1. 执行器通过 API 接口将更新数据传递给存储引擎执行更新操作；
        2. 存储引擎在拿到更新数据后，先将其更新到内存，同时将这个更新操作记录到 redo log，此时 redo log 处于 `prepare`
           状态，然后告知执行器执行完成了，随时可以提交事务；
        3. 执行器生成这个操作的 binlog，并把 binlog 写入磁盘；
        4. 执行器调用引擎的提交事务接口，引擎把刚刚写入的 redo log 改成 `commit` 状态，更新完成。

- **日志写入**

  WAL 技术（Write-Ahead Logging），即先写日志，再写磁盘。

    - redo log（重做日志）：循环写（后面的记录会覆盖前面的），InnoDB使用。
    - binlog（归档日志）：增量写（一直追加写入）

## EXPLAIN 语句解析

- `id`：查询序列号，标识执行顺序。SQL 语句中出现了几个 SELECT 关键字，就会分配几个查询 id，一般对于单表查询和连接查询，`id`
  值都是 1，对于联合查询和子查询，`id` 值会有多个；
- `select_type`：查询类型，主要是用于区分普通查询、联合查询、子查询等，其中 `SIMPLE` 表示普通查询（包含连接查询）、`UNION`
  表示联合查询、`SUBQUERY` 表示子查询；
- `table`：要执行查询的数据表；
- `partitions`：表分区（通常不会用到，可忽略）；
- `type`：SQL
  查询优化的重要指标，表示执行计划用到的索引类型，性能由高到低依次为：`system` > `const` > `eq_ref` > `ref` > `range` > `index` > `ALL`
  （以下是常见的类型值，不是所有）：
    - `system` 表示系统表查询或者 MyISAM、Memory 引擎表中只包含一条记录；
    - `const` 表示常量查询，通常主键索引或者唯一索引的单表等值匹配查询就是这种类型；
    - `eq_ref` 在连接查询中，被驱动表的主键索索引或唯一索引等值匹配会使用这个类型；
    - `ref` 通常对应二级索引的等值匹配查询，比如 b = 10000；
    - `range` 表示范围匹配；
    - `index` 表示索引树扫描，通常 count 查询会应用这个计划；
    - `ALL` 表示全表扫描，性能最差，通过对于没有设置索引的列进行过滤就会进行全表扫描。
- `possible_keys`：查询过程中有可能用到的索引；
- `key`：查询时实际使用的索引，如果为 NULL，则表示没有使用索引；
- `key_len`：索引长度，越小越好，整型通常是 4，字符串类型根据创建索引时指定的长度设定；
- `ref`：表示表的连接匹配条件，即哪些列或常量被用于查找索引列上的值，对于 `const` 类型单表等值匹配而言，其值是 `const`
  ，对于连接查询而言，就是被连接的列；
- `rows`：返回估算的结果集行数，不一定准确；
- `filtered`：表示返回结果的行数占需读取行数的百分比，越大越好；
- `extra`：展示一些额外信息（以下只是常见的额外信息，不是所有）：
    - `Using index` 表示使用了覆盖索引；
    - `Using where` 表示使用了 where 子句来过滤结果集；
    - `Using filesort` 表示查询过程中使用了文件排序，使用非索引列进行排序时出现，非常消耗性能，排序、分组查询时通常会用到；
    - `Using temporary` 表示查询过程中使用了临时表，分组、联合查询时通常会用到；
    - `Using join buffer` 表示连接查询时使用了 join buffer；
    - `Start temporary, End temporary` 表示 IN 子查询转化为 semijoin 时使用了 DuplicateWeedout 策略；
    - `LooseScan` 表示 IN 子查询转化为 semijoin 时使用了 LooseScan 策略；
    - `FirstMatch` 表示 IN 子查询转化为 semijoin 时使用了 FirstMatch 策略。

