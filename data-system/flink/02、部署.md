## 集群架构

- JobManager:管理节点,每个集群至少一个,管理整个集群计算资源,Job 管理与调度执行, 以及 Checkpoint 协调
- TaskManager:每个集群有多个TM,负责计算资源提供
- Client:本地执行应用 main() 方法解析JobGraph对象,并最终将JobGraph提交到JobManager运行,同时监控Job执行的状态

### JobManager

- Checkpoint Coordinator
- JobGraph -> Execution Graph
- Task 部署与调度
- RPC通信(Actor System)
- Job接收(Job Dispatch)
- 集群资源管理(ResourceManager)
- TaskManager注册与管理

### TaskManager

- Task Execution
- Network Manager
- Shuffle Environment
- Rpc通信 (Actor system)
- Heartbeat with JobManager And RM
- Data Exchange
- Memory Management
- Register To RM
- Offer Slots To JobManager

### Client

- Application's main() Method执行
- JobGraph Generate
- Execution Environment管理
- Job 提交与运行
- Dependencies Jar Ship
- RPC With JobManager
- 集群部署(Cluster Deploy)

### JobGraph

- 通过有向无环图(Dag)方式表达用户程序
- 不同接口程序的抽象表达
- 客户端和集群之间的Job描述载体
- 节点(Vertices),Result参数
- Flink 1.11之前只能在Client中生成

## 集群部署模式

根据以下两种条件将集群部署模式分为三种类型:

1. 集群的生命周期和资源隔离
2. 根据程序 main() 方法执行在 Client 还是JobManager

### Session Mode

- Session 运行模式
    - JobManager 与 TaskManager 共享
    - 客户端通过RPC或Rest API连接集群的管理节点
    - Deployer 需要上传依赖的 Dependencies Jar
    - Deployer 需要生成JobGraph,并提交到管理节点
    - JobManager 的生命周期不受提交的Job 影响,会长期运行
- Session 运行模式优点:
    - 资源充分共享,提升资源利用率
    - Job 在Flink Session 集群中管理,运维简单
- Session 运行模式缺点:
    - 资源隔离相对较差
    - 非 Native 类型部署,TM 不易拓展,Slot 计算资源伸缩性较差

### Per-Job Mode

- Per-Job 运行模式
    - 单个Job独享JobManager与TaskManager
    - TM 中 Slot 资源根据Job 指定
    - Deployer 需要上传依赖的 Dependencies Jar
    - 客户端生成JobGraph,并提交到管理节点
    - JobManager的生命周期和Job生命周期绑定
- Per-Job 运行模式优点:
    - Job 和Job 之间资源隔离充分
    - 资源根据Job需要进行申请,TM Slots数量可以不同
- Per-Job 运行模式缺点:
    - 资源相对比较浪费,JobManager需要消耗资源
    - Job 管理完全交给 ClusterManagement,管理复杂

### Application Mode

- Application 运行模式
    - 每个 Application 对应一个JobManager,且 可以运行多个Job
    - 客户端无需将 Dependencies 上传到 JobManager,仅负责管理Job 的提交与管理
    - main() 方法运行 JobManager 中,将 JobGraph 的生成放在集群上运行,客户端压力降低
- Application 运行模式优点:
    - 有效降低带宽消耗和客户端负载
    - Application 实现资源隔离,Application 中实现资源共享
- Application 运行模式缺点:
    - 功能太新,还未经过生产验证
    - 仅支持 Yarn 和 Kubernetes

## 集群资源管理器

| Cluster Management | Session 模式 | Per-Job 模式 | Application 模式 | Native 模式部署 | 是否生产可用 | 是否支持高可用 | 国内接受度 |
|--------------------|------------|------------|----------------|-------------|--------|---------|-------|
| Local              | 支持         | 不支持        | 不支持            | 不支持         | 否      | 不支持     | 低     |
| Standalone         | 支持         | 不支持        | 不支持            | 不支持         | 是      | 支持      | 低     |
| Yarn               | 支持         | 支持         | 支持             | 支持          | 是      | 支持      | 高     |
| Mesos              | 支持         | 支持         | 不支持            | 支持          | 是      | 支持      | 中     |
| Kubernetes         | 支持         | 支持         | 支持             | 支持          | 是      | 支持      | 高     |
| Docker             | 支持         | 支持         | 不支持            | 不支持         | 是      | 不支持     | 低     |

### Standalone 原理与实践

### Flink On Yarn 原理与实践

#### 架构概览

- ResourceManager:
    - 负责处理客户端请求
    - 监控 NodeManager
    - 启动和监控 ApplicationMaster
    - 资源的分配和调度
- NodeManager:
    - 管理单个 Worker 节点上的资源
    - 处理来自 ResourceManager 的命令
    - 处理来自 ApplicationMaster 的命令
    - 汇报资源状态
- Application Master:
    - 负责数据的切分
    - 为应用申请计算资源,并分配给 Task
    - 任务的监控与容错
    - 运行在 Worker 节点上
- Container:
    - 资源抽象,封装了节点上的多维度资源,如CPU,内存,网络资源等

### Flink On Kubernetes 原理与实践

#### 架构概览

- Master 节点:
    - 负责整个集群的管理,资源管理。
    - 运行APIServer,ControllerManager, Scheduler 服务
    - 提供 Etcd 高可用键值存储服务,用来保存 Kubernetes 集群所有对象的状态信息和网络信息
- Node:
    - 集群操作的单元,Pod 运行宿主机
    - 运行业务负载,业务负载会以 Pod 的形式运行
- Kubelet:
    - 运行在Node节点上,维护和管理该 Node上的容器
- Container Runtime:
    - Docker 容器运行环境,负责容器的创建和管理
- Pod:
    - 运行在 Node 节点上,多个相关 Container 的组合
    - Kubernetes创建和管理的最小单位













