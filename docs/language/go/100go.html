<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Essay - 100 go mistakes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../favicon.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Essay</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../docs/algorithm/index.html" rel="" target="">
 <span class="menu-text">Algorithm</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../docs/data-system/index.html" rel="" target="">
 <span class="menu-text">Data System</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-language" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Language</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-language">    
        <li>
    <a class="dropdown-item" href="../../../docs/language/go/index.html" rel="" target="">
 <span class="dropdown-text">Go</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../docs/language/rust/index.html" rel="" target="">
 <span class="dropdown-text">Rust</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../docs/language/javascript/index.html" rel="" target="">
 <span class="dropdown-text">JavaScript</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../docs/language/go/100go.html">Go</a></li><li class="breadcrumb-item"><a href="../../../docs/language/go/100go.html">100 go mistakes</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Go</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../docs/language/go/100go.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">100 go mistakes</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#代码和项目组织" id="toc-代码和项目组织" class="nav-link active" data-scroll-target="#代码和项目组织">代码和项目组织</a></li>
  <li><a href="#数据类型" id="toc-数据类型" class="nav-link" data-scroll-target="#数据类型">数据类型</a></li>
  <li><a href="#控制结构" id="toc-控制结构" class="nav-link" data-scroll-target="#控制结构">控制结构</a></li>
  <li><a href="#字符串" id="toc-字符串" class="nav-link" data-scroll-target="#字符串">字符串</a></li>
  <li><a href="#函数与方法" id="toc-函数与方法" class="nav-link" data-scroll-target="#函数与方法">函数与方法</a></li>
  <li><a href="#错误管理" id="toc-错误管理" class="nav-link" data-scroll-target="#错误管理">错误管理</a></li>
  <li><a href="#并发基础" id="toc-并发基础" class="nav-link" data-scroll-target="#并发基础">并发：基础</a></li>
  <li><a href="#并发实践" id="toc-并发实践" class="nav-link" data-scroll-target="#并发实践">并发：实践</a></li>
  <li><a href="#标准库" id="toc-标准库" class="nav-link" data-scroll-target="#标准库">标准库</a></li>
  <li><a href="#测试" id="toc-测试" class="nav-link" data-scroll-target="#测试">测试</a></li>
  <li><a href="#优化" id="toc-优化" class="nav-link" data-scroll-target="#优化">优化</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">100 go mistakes</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="代码和项目组织" class="level2">
<h2 class="anchored" data-anchor-id="代码和项目组织">代码和项目组织</h2>
<ol type="1">
<li><strong>意外的变量隐藏</strong> 要注意短声明是否会覆盖原先变量</li>
<li><strong>不必要的嵌套代码</strong> 简单可读，尽早返回</li>
<li><strong>滥用 init 函数</strong> init 在变量声明之后，main 函数之前执行，多个 init 函数按照声明顺序执行</li>
<li><strong>过度使用 getter 和 setter</strong> 尽量使用直接访问，不要过度封装</li>
<li><strong>接口污染</strong> 若无必要，勿增实体（抽象应该是被发现，而不是被创建）</li>
<li><strong>生产者的接口</strong> 一般放在消费端维护，若确有必要放在生产者一方，应尽量减小抽象</li>
<li><strong>返回接口</strong> 一般返回具体抽象</li>
<li><strong>any 意味着 nothing</strong> any 丢失了类型信息，使用时应谨慎</li>
<li><strong>乱用泛型</strong> 应在一些通用的数据结构和函数中使用</li>
<li><strong>误用嵌入类型</strong> 小心方法提升</li>
<li><strong>不使用函数选项模式</strong> 萝卜青菜，各有所爱</li>
<li><strong>项目无组织</strong> 社区公约 golang-standards</li>
<li><strong>创建通用包</strong> 不推荐 common、util、shared 等没有具体含义的包</li>
<li><strong>变量和包名冲突</strong> 小心变量和包名冲突</li>
<li><strong>缺少代码文档</strong> 每个导出的元素都应有文档</li>
<li><strong>不使用 linters</strong> 磨刀不误砍柴工</li>
</ol>
</section>
<section id="数据类型" class="level2">
<h2 class="anchored" data-anchor-id="数据类型">数据类型</h2>
<ol start="17" type="1">
<li><strong>使用 8 进制字面量</strong> 二进制：<code>0b</code>，八进制：<code>0o</code>，十六进制：<code>0x</code></li>
<li><strong>忽略整数溢出</strong> Go 对溢出是静默的</li>
<li><strong>不了解浮点数</strong> float32 精度 7 位，float64 精度 15 位</li>
<li><strong>不了解切片的长度和容量</strong> 长度是指切片中元素的个数，容量是指底层数组中元素的个数</li>
<li><strong>低效的切片初始化</strong> 初始化时指定容量，避免频繁扩容</li>
<li><strong>对 nil 和空切片的困惑</strong> nil 和空切片的长度都为0，nil 不需要分配</li>
<li><strong>不正确检查切片为空</strong> <code>len(s) != 0</code></li>
<li><strong>不正确复制切片</strong> <code>copy(dst, src)</code> 会复制 <code>min(len(dst), len(src))</code> 个元素</li>
<li><strong>忽视 append 的副作用</strong> append 可能会导致底层数组重新分配，导致之前的切片失效</li>
<li><strong>切片内存泄露</strong> 切片容量泄漏、底层数组泄漏</li>
<li><strong>低效的 map 初始化</strong> 初始化时指定容量，避免频繁扩容</li>
<li><strong>map 内存泄漏</strong> map 的桶会随着元素的增加而增加，但是不会随着元素的删除而减少</li>
<li><strong>比较值时犯错</strong> <code>reflect.DeepEqual()</code>
<ul>
<li><strong>Booleans</strong> 比较两个布尔值是否相等</li>
<li><strong>Numerics</strong> 比较数字是否相等</li>
<li><strong>Strings</strong> 比较字符串是否相等</li>
<li><strong>Channels</strong> 比较两个通道是否指向同一个通道或者都是 nil</li>
<li><strong>Interfaces</strong> 比较两个接口是否具有相同的动态类型且值相等或者都是 nil</li>
<li><strong>Pointers</strong> 比较两个指针是否指向同一个对象或者都是 nil</li>
<li><strong>Structs and Arrays</strong> 比较结构体或者数组的每个元素是否相等</li>
</ul></li>
</ol>
</section>
<section id="控制结构" class="level2">
<h2 class="anchored" data-anchor-id="控制结构">控制结构</h2>
<ol start="30" type="1">
<li><strong>忽视遍历时元素被复制</strong> for range 时， 元素会被复制，修改的是副本</li>
<li><strong>忽视遍历时参数怎么计算</strong> for range 时，参数只会计算一次；若需要每次都计算，应使用普通 for 循环</li>
<li><strong>忽视遍历时指针元素的影响</strong> for range 时，元素都会分配给一个具有唯一地址的变量，每次迭代存储引用该指针的变量的话，只会存储最后的值</li>
<li><strong>遍历 map 时想当然</strong> map 是无序的，每次遍历的顺序都可能不一样；遍历时插入元素，可能会出现在遍历中，也可能被跳过</li>
<li><strong>忽视 break 的工作机制</strong> break 只会跳出当前循环，若想跳出多层循环，应使用标签</li>
<li><strong>在循环中使用 defer</strong> 会堆积所有 defer，如果循环没有终止，会导致内存泄漏</li>
<li><strong>忽视闭包中的参数</strong> 闭包中的参数是引用，而不是值</li>
</ol>
</section>
<section id="字符串" class="level2">
<h2 class="anchored" data-anchor-id="字符串">字符串</h2>
<ol start="36" type="1">
<li><strong>不理解 rune</strong> rune 是 int32 的别名，可以由多个字节组成；len(s) 返回的是字节数，而不是字符数</li>
<li><strong>不正确的字符串遍历</strong> for range 遍历字符串时，会将字符串转换为 rune 数组，而不是字节数组</li>
<li><strong>乱用 trim</strong> 要了解 <code>strings.TrimRight() strings.TrimSuffix()</code> 的区别</li>
<li><strong>未对字符串连接进行优化</strong> 使用 <code>strings.Builder</code> 进行字符串拼接</li>
<li><strong>无用的字符串转换</strong> 确认需不需要对 string 和 []byte 进行互转</li>
<li><strong>字符串内存泄漏</strong> 子串占用母串</li>
</ol>
</section>
<section id="函数与方法" class="level2">
<h2 class="anchored" data-anchor-id="函数与方法">函数与方法</h2>
<ol start="42" type="1">
<li><strong>不知道选择哪种接收器类型</strong> 若需要修改接收器的值或其中包含一个无法复制的字段，必须使用指针接收器</li>
<li><strong>从不使用命名的返回值</strong> 提升代码可读性</li>
<li><strong>未预期的命名返回值的副作用</strong> 注意变量隐藏</li>
<li><strong>返回一个 nil 接收器</strong> nil 接收器 != nil ⭐️⭐️⭐️</li>
<li><strong>使用文件名作为函数输入</strong> 增加代码测试的复杂性</li>
<li><strong>忽视 defer 的参数和接收器的评估</strong> defer 会在函数返回前执行，但是参数和接收器是在使用 defer 语句是评估的；可以使用闭包</li>
</ol>
</section>
<section id="错误管理" class="level2">
<h2 class="anchored" data-anchor-id="错误管理">错误管理</h2>
<ol start="48" type="1">
<li><strong>panic</strong> 谨慎使用 panic</li>
<li><strong>忽视何时封装错误</strong> <code>fmt.Errorf("detail error: %w", err)</code></li>
<li><strong>不准确的错误类型检查</strong> 使用 <code>errors.As()</code> 对封装后的错误类型进行检查</li>
<li><strong>不准确的错误值检查</strong> 使用 <code>errors.Is()</code> 对封装后的错误值进行检查</li>
<li><strong>两次处理同一个错误</strong> 要么记录日志，要么返回错误（可以使用 <code>fmt.Errorf()</code> 进行封装）</li>
<li><strong>不处理错误</strong> 对某个错误不感兴趣，将其赋值给 <code>_</code> 语义会更明确</li>
<li><strong>不处理 defer 中的错误</strong> 有可能导致资源未被释放</li>
</ol>
</section>
<section id="并发基础" class="level2">
<h2 class="anchored" data-anchor-id="并发基础">并发：基础</h2>
<ol start="55" type="1">
<li><strong>混淆并发和并行</strong> 并发是指两个或多个任务在时间上重叠，而并行是指两个或多个任务在同一时刻执行</li>
<li><strong>认为并发总是更快</strong> 当任务开销小于 goroutine 的开销时，并发会降低性能</li>
<li><strong>不知道使用 channel 还是 mutex</strong> 一般来说，并发 goroutines 需要使用 channel，而并行 goroutines 需要使用 mutex</li>
<li><strong>不理解竞争问题</strong> 原子操作；使用互斥锁；使用 channel</li>
<li><strong>不知道工作负载类型</strong> CPU 密集型、I/O 密集型</li>
<li><strong>不理解 Go context</strong> context 用于在 goroutine 之间传递请求作用域的数据、取消信号和截止日期</li>
</ol>
</section>
<section id="并发实践" class="level2">
<h2 class="anchored" data-anchor-id="并发实践">并发：实践</h2>
<ol start="61" type="1">
<li><strong>传播不恰当的 context</strong> 子任务的话要清楚父任务的 context 是否需要传递</li>
<li><strong>启动一个不知道何时停止的 goroutine</strong> 设计时要考虑怎么停止 goroutine</li>
<li><strong>使用 goroutine 和循环变量时不谨慎</strong> for range 常见问题</li>
<li><strong>使用 select/channel 保证确定性</strong> select 是伪随机的</li>
<li><strong>不使用通知类型 channel</strong> 使用 <code>chan struct{}</code> 作为通知类型 channel</li>
<li><strong>不使用 nil channel</strong> 一般不使用</li>
<li><strong>对 channel 缓冲区大小感到困惑</strong> 只有无缓冲才能保证同步性</li>
<li><strong>忘记字符串格式化的副作用</strong> String() 可能不是并发安全的，甚至死锁</li>
<li><strong>使用 append 导致数据竞争</strong> 切片 append 不是并发安全的</li>
<li><strong>在 slice 和 map 中错误使用互斥锁</strong> slice 和 map 是指针类型</li>
<li><strong>错误使用 sync.WaitGroup</strong> 不要在 子goroutine 中使用 wg.Add()</li>
<li><strong>忘记还有 sync.Cond</strong> 同时向多个 goroutine 发送信号</li>
<li><strong>不使用 errgroup</strong> 不要重复造轮子</li>
<li><strong>复制同步原语</strong> 使用指针</li>
</ol>
</section>
<section id="标准库" class="level2">
<h2 class="anchored" data-anchor-id="标准库">标准库</h2>
<ol start="75" type="1">
<li><strong>提供错误的持续时间</strong> 使用 <code>time.Second()</code> 而不是 1e9</li>
<li><strong>time.After 内存泄漏</strong> 只有当计时器过期时，创建的资源才会释放，在循环中要使用 <code>time.NewTimer</code> 来替代</li>
<li><strong>常见的 JSON 处理错误</strong> 类型嵌入；时间类型；any 中的数字被认为是 float64</li>
<li><strong>常见的 SQL 错误</strong>
<ul>
<li><code>sql.Open()</code> 并不建立连接，只是验证参数</li>
<li><code>*sql.DB</code> 是一个连接池</li>
<li>要使用 Prepared Statement</li>
<li>要使用 sql.Nullxxx</li>
<li>要处理迭代中的错误</li>
</ul></li>
<li><strong>没有释放临时资源</strong> <code>resp.Body</code> <code>sql.Rows</code> <code>os.File</code></li>
<li><strong>处理 http 请求时没有返回</strong> <code>http.Error</code> 后立即返回</li>
<li><strong>使用默认的 http 客户端和服务端</strong> 要设置超时时间</li>
</ol>
</section>
<section id="测试" class="level2">
<h2 class="anchored" data-anchor-id="测试">测试</h2>
<ol start="82" type="1">
<li><strong>未区分测试种类</strong> <code>export MY_ENV=test / go test --tags=... -short</code></li>
<li><strong>未打开 -race 开关</strong> 本地测试时要打开</li>
<li><strong>未使用测试执行模式</strong> -parallel -shuffle</li>
<li><strong>未使用表驱动型测试</strong> 用表驱动型测试替代 if/else</li>
<li><strong>在单元测试中休眠</strong> 引入重试代替休眠</li>
<li><strong>没有有效使用 tim e</strong> mock 或者重构时间相关代码</li>
<li><strong>未使用测试工具包</strong> httptest iotest 等</li>
<li><strong>编写不准确的基准测试</strong> 一些基础测试的误区</li>
<li><strong>未探索所有的 go 测试特性</strong> 代码覆盖率等等</li>
</ol>
</section>
<section id="优化" class="level2">
<h2 class="anchored" data-anchor-id="优化">优化</h2>
<ol start="91" type="1">
<li><strong>不了解 CPU 缓存</strong> 编写 CPU 缓存友好的代码</li>
<li><strong>编写导致伪共享的并发代码</strong> 通过填充或通信来防止伪共享</li>
<li><strong>不考虑指令级并行性</strong> 充分利用指令流水线并行</li>
<li><strong>不了解数据对齐</strong> 对齐保证更好的空间局部性</li>
<li><strong>不了解栈与堆</strong> 尽量避免在堆上分配内存</li>
<li><strong>不了解如何减少分配</strong> 初始容量和池化技术</li>
<li><strong>没有依赖内联</strong> 内联是提升性能的有效手段</li>
<li><strong>没有使用 Go 诊断工具</strong> profile trace</li>
<li><strong>不了解 GC 的工作原理</strong> 了解一些 GC 细节</li>
<li><strong>不了解容器对 Go 程序的影响</strong> 了解一些 GC 细节</li>
</ol>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>